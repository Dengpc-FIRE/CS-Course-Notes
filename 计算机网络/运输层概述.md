

# 运输层概述

**通信的真正实体是位于通信两端的主机中的进程**

**为通信两端主机提供直接服务的是运输层的任务**

![image-20221126154722706](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126154722706.png)

![image-20221126154958457](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126154958457.png)

# 运输层端口号、复用与分用的概念

![image-20221126155327723](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126155327723.png)

**发送方的复用与接收方的复用**

![image-20221126155559109](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126155559109.png)

TCP/IP体系的应用层常用协议所使用的运输层熟知端口号

![image-20221126155748731](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126155748731.png)



# UDP和TCP对比

![image-20221126161436465](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126161436465.png)

![image-20221126161540913](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126161540913.png)

![image-20221126161754949](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126161754949.png)

![image-20221126162001641](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126162001641.png)



# TCP的流量控制

**如果发送方把数据发送的过快，接收方可能来不及接收，这就会造成数据丢失**

**流量控制就是不让发送方的发送速率太快，要让接收方来得及接收**

**利用滑动窗口机制在TCP连接上实现对发送方的流量控制**

**举例**

![image-20221126164444437](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126164444437.png)



![image-20221126164527926](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126164527926.png)

**练习**

![image-20221126164402388](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126164402388.png)

# TCP拥塞控制

在某时间中，对网络智能某一资源的需求超过了该资源所能提供的可用部分，网络性能就要变坏。

> 网络中链路容量（带宽）、交换结点中的缓存和处理机等，都是网络的资源

若出现拥塞而不进行控制，整个网络随输入负荷的增大而下降

![img](https://img2022.cnblogs.com/blog/3006655/202211/3006655-20221126170648451-2002264493.png)

**拥塞控制算法**

![image-20221126171007596](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126171007596.png)

**模拟过程**

![image-20221126171819096](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126171819096.png)

**弊端**

![image-20221126172012747](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126172012747.png)

**快重传**

![image-20221126172440736](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126172440736.png)

**快恢复**

![image-20221126172950005](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126172950005.png)

**模拟**

![image-20221126172818307](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126172818307.png)

**练习**

![image-20221126173441224](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126173441224.png)



# TCP超时重传时间的选择

![image-20221126173929496](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126173929496.png)

**RTO的计算**

![image-20221126174235634](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126174235634.png)

**RTO是依照RTTs计算的，但RTT测量有可能出错**

![image-20221126174604225](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126174604225.png)

**解决：报文段每重传一次，就把超时重传时间RTO增大一些。一般是将新RTO的值取为旧RTO值的2倍**

![image-20221126175449652](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126175449652.png)



# TCP可靠传输的实现

基于**以字节为单位的滑动窗口**来实现可靠传输

![image-20221126180243834](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126180243834.png)



**练习**

![image-20221126181746846](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126181746846.png)

![image-20221126181912938](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126181912938.png)



# TCP的运输连接管理——TCP的连接建立

![image-20221126192112368](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126192112368.png)

解决以下三个问题

1. 使TCP双方能够确知对方的存在
2. 使TCP双方能够协商一些参数
3. 使TCP双方能够对运输实体资源（缓存大小）等进行分配

![image-20221126192850972](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126192850972.png)

**如果采用两次握手就建立连接的话，出现问题**

![image-20221126193145461](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126193145461.png)

**不多余，防止已失效的连接请求报文段突然又传送到TCP服务器，因而导致错误。**

**SYN=1的报文段不能携带数据，但要消耗掉一个序号**

**普通的确认报文段假如不能携带数据，则不消耗序号**



# TCP运输连接管理——TCP的连接释放

![image-20221126194423672](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126194423672.png)

**时间等待意义**

![image-20221126194716741](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126194716741.png)

![image-20221126194936386](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126194936386.png)



# TCP报文段的首部格式

![image-20221126195447007](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126195447007.png)

**序号**

![image-20221126195537761](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126195537761.png)

**确认号：**指出期望收到对方下一个TCP报文段的数据载荷的第一个字节的序号，同时也是对之前所收到的所有数据的确认

若确认号=n，则表明到序号n-1为止的所有数据都已正确接受，期望接受序号为n

**确认标志位ACK：**取值为1时确认号才有效，取值为0时确认字段无效。TCP规定，在连接建立后所有传送的TCP报文段必须把ACK置1.

**数据偏移：**占四个比特，以4字节为单位。用来指出TCP报文段的数据载荷部分的起始处距离TCP报文段的起始处有多远

这个字段实际指出了TCP报文段的首部长度

![image-20221126200653667](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126200653667.png)

**窗口：**16比特，字节为单位。指出发送本报文段的一方的接收窗口。

窗口值作为接收方让发送方设置其发送窗口的依据

（发送窗口还取决于拥塞窗口的大小，两者取min）

这是以接收方的接受能力来控制发送方的发送能力，成为流量控制

**校验和：**检查范围包括TCP报文段的首部和数据载荷两部分

计算校验和时，要在TCP报文段的前面加上12字节的伪首部

**同步标志位SYN：**在TCP连接建立时用来同步序号

**终止标志位FIN：**用来释放TCP连接

**复位标志位RST：**用来复位TCP连接

**推送标志位PSH：**接收方的TCP收到该标志位为1的报文段会尽快上交应用进程，不比等到接受缓存都填满后再向上交付

![image-20221126202019663](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126202019663.png)

![image-20221126202143534](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221126202143534.png)