# 网络层概述

> **网络层的主要任务是实现网络互联，进而实现数据包在各网络之间的传输**
>
> 要实现网络层任务，需要解决
>
> 1. 网络层向运输层提供怎样的服务（可靠传输还是不可靠传输）
> 2. 网络层寻址问题
> 3. 路由选择问题

![image-20221125095558896](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125095558896.png)



# 网络层提供的两种服务

**面向连接的虚电路服务，无连接的数据报服务**

## 面向连接的虚电路服务

![image-20221125100053049](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125100053049.png)



## 无连接的数据报服务

![image-20221125100706431](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125100706431.png)

![image-20221125100834309](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125100834309.png)



# IPv4地址

**IPv4地址就是给因特网（Internet）上的每一台主机（或路由器）的每一个接口分配一个全世界范围内是唯一的32比特的标识符**

**IPv4地址采用点分十进制表示方法**

## 分类编址的IPv4地址

![image-20221125101811676](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125101811676.png)

**A类地址**

![image-20221125102302518](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125102302518.png)

**C类地址**

![image-20221125102825215](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125102825215.png)

![image-20221125103137364](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125103137364.png)

**练习**

![image-20221125103354289](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125103354289.png)

## 划分子网的IPv4地址

![image-20221125104855359](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125104855359.png)

![image-20221125105526329](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125105526329.png)

![image-20221125105731568](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125105731568.png)

## 无分类编址的IPv4地址

**无分类域间路由选择CIDP，消除传统A类，B类，C类地址，以及划分子网的概念。**

**CIDR**

![image-20221125110242078](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125110242078.png)

![image-20221125110528323](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125110528323.png)

**路由聚合**

![image-20221125113952153](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125113952153.png)

![image-20221125113800106](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125113800106.png)

## IPv4地址的应用规划

![image-20221125114743056](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125114743056.png)

**定长的子网掩码FLSM**

![image-20221125145810649](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125145810649.png)

**变长的子网掩码VLSM**

![image-20221125150750116](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125150750116.png)



# IP数据报的发送和转发过程

## 

1.如何判断源主机与目的主机是否在同一个网络

源主机将自己的IP地址与子网掩码相与，得到自己的网络地址，然后将目的主机的IP地址与自己的子网掩码相与，得到目的网路，然后判断是否在同一个网络。

2.主机如何判断应该将IP数据报交给哪个路由器进行转发？

一般将路由器接口IP作为默认网关，当通信时，源主机将IP数据报传输给默认网关，由默认网关帮主机将IP数据报转发出去。

![image-20221125152223487](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125152223487.png)

在查找路由表时，将目的地址与路由表中各个地址掩码相与，得到目的网络地址，然后将目的网络地址与此掩码在路由表中对应的目的网络地址相对照，判断是否是匹配的路由条目

从原接口（同一个网络）出来是直接交付，其他是间接交付

![image-20221125152824359](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125152824359.png)

路由器住隔离广播域的，收到广播IP数据报不会转发

![image-20221125153153900](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125153153900.png)

![image-20221125153328781](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125153328781.png)



# 静态路由配置及其可能产生的路由环路问题

### 概念

**静态路由是管理员或用户使用路由器相关命令给路由器人工配置路由表**

![image-20221125154106329](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125154106329.png)

### **默认路由**

**问题**：**如何转发IP数据报到包含众多网络的因特网**

对于具有相同下一跳的不同目的网络的路由条目，可以用默认路由替代

![image-20221125154722880](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125154722880.png)

### 静态路由配置错误导致的路由环路问题

（1）配置错误

![image-20221125155002863](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125155002863.png)

（2）聚合不存在网络

![image-20221125155332083](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125155332083.png)

转发一条不存在的但属于聚合路由里面的，转发到R1后没找到就走默认路由，又转发回来，产生了路由环路

解决：添加黑洞路由，这样就丢弃了

![image-20221125155735956](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125155735956.png)

（3）网络故障

![image-20221125155919782](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125155919782.png)

没有黑洞路由会产生路由回路，故障解决后，黑洞路由失效。再次产生故障的话，再自动生效。



# 路由选择协议

## 概述

![image-20221125160231825](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125160231825.png)

![image-20221125160500167](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125160500167.png)

![image-20221125160818023](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125160818023.png)

![image-20221125161136575](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125161136575.png)

## 路由信息协议RIP的基本工作原理

**动态路由协议**

**RIP使用跳数作为度量来衡量到达目的网络的距离**

> 1. 路由器到达直连网络的距离定义为1
> 2. 到达非直连网络的句里定义为多经过的路由器数加一
> 3. 允许一条路径最多只能包含15个路由器，“距离”等于16时相当于不可达，因此RIP只适用于小型网络

RIP选择距离短的路由，当距离相等时，进行等价负载均衡（信息平均发送）

![image-20221125162206838](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125162206838.png)

**路由条目更新规则**

![image-20221125162710102](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125162710102.png)

**存在问题**

![image-20221125163353779](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125163353779.png)

## 开放最短路径优先OSPF的基本工作原理

![image-20221125164620294](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125164620294.png)



![image-20221125164716548](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125164716548.png)

![image-20221125164858291](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125164858291.png)

![image-20221125164527215](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125164527215.png)

![image-20221125165254934](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125165254934.png)

## 边界网关协议BGP的基本工作原理

处在这，以后看？

![image-20221125165645240](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125165645240.png)

![image-20221125165853089](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125165853089.png)

![image-20221125170015073](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125170015073.png)

![image-20221125170145032](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125170145032.png)

![image-20221125170331905](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125170331905.png)

![image-20221125170420843](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125170420843.png)

![image-20221125170458057](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125170458057.png)



# IPv4数据报首部格式

这些东西真的有人能记住？

![image-20221125172016409](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125172016409.png)

![image-20221125172254671](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125172254671.png)

![image-20221125172458861](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125172458861.png)

**分片**

![image-20221125173149150](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125173149150.png)

![image-20221125174014506](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125174014506.png)

![image-20221125174410076](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125174410076.png)

![image-20221125174515577](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125174515577.png)

**练习**

![image-20221125174800341](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125174800341.png)

![image-20221125174941090](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125174941090.png)

![img](https://img2022.cnblogs.com/blog/3006655/202211/3006655-20221125175323134-1010864967.png)

![img](https://img2022.cnblogs.com/blog/3006655/202211/3006655-20221125175401804-1909578246.png)

![image-20221125175538833](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125175538833.png)



# 网际控制报文协议ICMP

> 为了更有效转发IP数据报和提高交付成功的机会，在网际层使用了网际控制报文协议ICMP
>
> 主机或者路由器使用ICMP来发送差错报告报文和询问报文
>
> ICMP报文被封装在IP数据报中发送

## ICMP差错报告报文

![image-20221125192049900](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125192049900.png)

**源点抑制：**当路由器或者主机由于拥塞而丢弃数据报时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢

**时间超过：**当路由器收到一个目的IP地址不是自己的IP数据报时，会将其生存时间TTL字段的值减1，若结果不为0，则将该IP数据报转发出去；若结果为0，除丢弃该IP数据报 外，还要向源点发送时间超过报文。另外，当终点预先规定的时间内不能收到一个数据报的全部数据片时，就把已收到的数据片都丢弃，也会向源点发送时间超过报文。

**参数问题：**当路由器或目的主机收到IP数据报之后，根据首部中的检验和字段发现首部在传输过程中出现了误码，就丢弃该数据段，并向源点发送参数问题报文。

**改变路由（重定向）：**路由器把改变路由报文发送给主机，让主机知道下次应该将数据报发送给另外的路由。（可通过更好的路由）

![image-20221125193800505](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125193800505.png)

**常用ICMP询问报文**

![image-20221125194157151](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125194157151.png)

## 应用举例

![image-20221125194436095](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125194436095.png)

![image-20221125194840429](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125194840429.png)

![image-20221125194944282](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125194944282.png)



# 虚拟专用网VPN与网络地址转换NAT

## 虚拟专用网

虚拟专用网：利用公用的因特网作为本机构各专用网之间的通信载体。

![image-20221125195407227](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125195407227.png)

![image-20221125200051175](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125200051175.png)

## **网络地址转换**

![image-20221125200911565](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125200911565.png)

![image-20221125201013333](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125201013333.png)

![image-20221125201115177](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125201115177.png)

![image-20221125201214121](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125201214121.png)

![image-20221125201359434](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125201359434.png)

![image-20221125201500321](C:\Users\邓\AppData\Roaming\Typora\typora-user-images\image-20221125201500321.png)